Video<br />
<video id="video1" width="160" height="120" autoplay muted></video> <br />

Logs<br />
<div id="logs"></div>

<script>
    const conn = new WebSocket(`ws://${location.host}/webrtc`);

    let pc = new RTCPeerConnection({
        iceServers: [
            {
                urls: "stun:stun.l.google.com:19302",
            },
        ],
    });
    var log = (msg) => {
        document.getElementById("logs").innerHTML += msg + "<br>";
    };

    navigator.mediaDevices
        .getUserMedia({ video: true, audio: false })
        .then((stream) => {
            stream.getTracks().forEach((track) => pc.addTrack(track, stream));
            document.getElementById("video1").srcObject = stream[0];
        })
        .catch(log);

    pc.oniceconnectionstatechange = (e) => log(pc.iceConnectionState);

    pc.onicecandidate = e => {
        
    };

    conn.addEventListener("close", (ev) => {
        console.log(`WebSocket Disconnected code: ${ev.code}, reason: ${ev.reason}`);
    });

    conn.addEventListener("open", (ev) => {
        console.info("websocket connected");

        pc.createOffer()
            .then(sdp => {
                pc.setLocalDescription(sdp)
                    .then(() => {
                        console.log("set local description", sdp)
                    })
                    .catch(console)

                let msg = {
                    event: "offer",
                    sdp: JSON.stringify(sdp),
                };

                conn.send(JSON.stringify(msg));

                console.log("sent offer");
            })
            .catch(console);
    });

    conn.addEventListener("message", (ev) => {
        console.log(`received message: ${ev.data}`);

        let msg = JSON.parse(ev.data);
        if (!msg) {
            return console.error("failed to parse msg");
        }

        switch (msg.event) {
            case "answer":
                let answer;
                try {
                    answer = JSON.parse(msg.sdp);
                } catch (e) {
                    return console.error("failed to parse answer");
                }

                console.log("received answer", answer);

                pc.setRemoteDescription(answer)
                    .then(() => {
                        console.log("set remote description");
                    })
                    .catch((e) => console.error(e));
                break;
        }
    });
</script>
