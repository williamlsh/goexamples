Video<br />
<video id="video1" width="160" height="120" autoplay muted></video> <br />

Logs<br />
<div id="logs"></div>

<script>
    const conn = new WebSocket(`ws://${location.host}/webrtc`);

    var log = msg => {
        document.getElementById("logs").innerHTML += msg + "<br>";
    };

    let pendingOutgoingCandidates = []
    let pendingIncomingCandidates = []
    let answered = false
    let pc = new RTCPeerConnection();

    conn.addEventListener("close", (ev) => {
        console.log(`WebSocket Disconnected code: ${ev.code}, reason: ${ev.reason}`);
    });

    conn.addEventListener("open", (ev) => {
        console.info("websocket connected");

        navigator.mediaDevices
            .getUserMedia({ video: true, audio: false })
            .then(stream => {
                stream.getTracks().forEach(track => pc.addTrack(track, stream));
                document.getElementById("video1").srcObject = stream;

                console.log("got user media")

                pc.createOffer()
                    .then(d => {
                        pc.setLocalDescription(d).catch(console)

                        let msg = {
                            event: "offer",
                            data: JSON.stringify(d),
                        };
                        conn.send(JSON.stringify(msg));

                        console.log("sent offer");

                        pc.oniceconnectionstatechange = (e) => log(pc.iceConnectionState);

                        pc.onicecandidate = (e) => {
                            if (e.candidate == null) {
                                return
                            }

                            if (pc.remoteDescription == null) {
                                console.log("pending candidate")

                                pendingOutgoingCandidates.push(e.candidate)
                                return
                            }

                            sendCandidate(e.candidate)
                        }
                    })
                    .catch(log);
            })
            .catch(log);
    });

    conn.addEventListener("message", (ev) => {
        console.log(`received message: ${ev.data}`);

        let msg = JSON.parse(ev.data);
        if (!msg) {
            return console.error("failed to parse msg");
        }

        switch (msg.event) {
            case "answer":
                let answer;
                try {
                    answer = JSON.parse(msg.data);
                } catch (e) {
                    return console.error("failed to parse answer");
                }

                console.log("received answer", answer);

                pc.setRemoteDescription(answer)
                    .then(() => {
                        console.log("set remote description");

                        answered = true

                        console.log("pending outgoing candidates length", pendingOutgoingCandidates.length)
                        pendingOutgoingCandidates.forEach(c => sendCandidate(c))

                        console.log("pending incoming candidates length", pendingIncomingCandidates.length)
                        pendingIncomingCandidates.forEach(c => addCandidate(c))
                    })
                    .catch((e) => console.error(e));
                break;
            case "candidate":
                if (!answered) {
                    console.log("not receiving the answer yet")

                    pendingIncomingCandidates.push(msg.data)
                    return
                }
                try {
                    addCandidate(msg.data)

                    console.log("pending incoming candidates length", pendingIncomingCandidates.length)
                    pendingIncomingCandidates.forEach(c => addCandidate(c))
                } catch (e) {
                    console.error(e)
                }
                break;
            default:
                console.log("unknown event")
                break;
        }
    });

    function sendCandidate(candidate) {
        let msg = {
            event: "candidate",
            data: JSON.stringify(candidate)
        }
        conn.send(JSON.stringify(msg))

        console.log("sent a candidate")
    }

    function addCandidate(str) {
        let candidate
        try {
            candidate = JSON.parse(str)
        } catch (e) {
            return console.log('failed to parse candidate')
        }
        if (!candidate) {
            return console.log('empty candidate')
        }
        pc.addIceCandidate(candidate)
            .then(() => console.log("added a candidate"))
            .catch(e => console.error(e))
    }
</script>
